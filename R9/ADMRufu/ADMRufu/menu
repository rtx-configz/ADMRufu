#!/bin/bash
# -*- ENCODING: UTF-8 -*-
# Updated for Ubuntu 25.04 & 25.10 - English Version - Fixed - 2025-11-11

rm -rf instalscript.sh &>/dev/null
module="/etc/ADMRufu/module"
[[ ! -e ${module} ]] && exit
source ${module}

export _hora=$(printf '%(%H:%M:%S)T') 
export _fecha=$(printf '%(%D)T')

export ADMRufu="/etc/ADMRufu" && [[ ! -d ${ADMRufu} ]] && mkdir -p ${ADMRufu}
export ADM_inst="${ADMRufu}/install" && [[ ! -d ${ADM_inst} ]] && mkdir -p ${ADM_inst}
export ADM_src="${ADMRufu}/source" && [[ ! -d ${ADM_src} ]] && mkdir -p ${ADM_src}
export ADM_crt="${ADM_src}/cert" && [[ ! -d ${ADM_crt} ]] && mkdir -p ${ADM_crt}
export ADM_slow="${ADM_src}/slowdns" && [[ ! -d ${ADM_slow} ]] && mkdir -p ${ADM_slow}
export ADM_user="${ADMRufu}/user" && [[ ! -d ${ADM_user} ]] && mkdir -p ${ADM_user}
export ADM_tmp="${ADMRufu}/tmp" && [[ ! -d ${ADM_tmp} ]] && mkdir -p ${ADM_tmp}
export numero='^[0-9]+$'
export letra='^[A-Za-z]+$'
export tx_num='^[A-Za-z0-9]+$'

export v2rdir="${ADMRufu}/v2r" && [[ ! -d ${v2rdir} ]] && mkdir -p ${v2rdir}
export user_conf="${v2rdir}/user" && [[ ! -e $user_conf ]] && touch $user_conf
export backdir="${v2rdir}/back" && [[ ! -d ${backdir} ]] && mkdir -p ${backdir}
export tmpdir="$backdir/tmp"
export config="/etc/v2ray/config.json"
export temp="/etc/v2ray/temp.json"
export fstab="/etc/fstab"
export sysctl="/etc/sysctl.conf"
export swap="/swapfile"

#======cloudflare========
export _dns='2473a8a21bd6a727d7d6eed58a6751a0'
export apikey='ZN685I3ss0lEvQOr79SVYsYVDviz9GGRys_Upgu0'
export _domain='admrufu.online'
export url='https://api.cloudflare.com/client/v4/zones'
#========================

#PROCESSOR
export _core=$(printf '%-1s' "$(grep -c cpu[0-9] /proc/stat)")
export _usop=$(printf '%-1s' "$(top -bn1 | awk '/Cpu/ { cpu = "" 100 - $8 "%" }; END { print cpu }')")

#SYSTEM-CPU USAGE-RAM MEMORY
export ram1=$(free -h | grep -i mem | awk '{print $2}')
export ram2=$(free -h | grep -i mem | awk '{print $4}')
export ram3=$(free -h | grep -i mem | awk '{print $3}')

export _ram=$(printf ' %-9s' "$(free -h | grep -i mem | awk '{print $2}')")
export _usor=$(printf '%-8s' "$(free -m | awk 'NR==2{printf "%.2f%%", $3*100/$2 }')")

if [[ ! -f ${ADM_tmp}/style ]]; then
  echo -e "infsys 1\nport 0\nresel 0\ncontador 1\nlimit 0" > ${ADM_tmp}/style
fi

if [[ ! $(id -u) = 0 ]]; then
	clear
	msg -bar
	print_center -ama "EXECUTION ERROR"
	msg -bar
	print_center -ama "YOU MUST RUN FROM ROOT USER"
	echo ''
	print_center -ama 'TRY "sudo su"'
	print_center -ama 'OR'
	print_center -ama '"sudo menu"'
	msg -bar
	exit
fi

if [[ ! $(cat '/etc/passwd'|grep 'root'|grep -v 'false'|awk -F ':' '{print $2}') = 'x' ]]; then
	msg -bar
	print_center -ama 'ROOT PASSWORD CHANGE REQUIRED'
	msg -bar
	msg -ne " Enter New Password: "
	read opcion
	pwconv
	(echo "$opcion" ; echo "$opcion")|passwd root &>/dev/null
	tput cuu1 && tput dl1
	print_center -verd "ROOT PASSWORD CHANGED"
	enter
fi

[[ ! -e "/var/spool/cron/crontabs/root" ]] && touch /var/spool/cron/crontabs/root

#======BODY=========

in_opcion(){
	msg -ne " $1: "
	read opcion
}

fun_trans(){ 
	local texto
	local retorno
	declare -A texto
	SCPidioma="${ADM_tmp}/idioma"
	[[ ! -e ${SCPidioma} ]] && touch ${SCPidioma}
	local LINGUAGE=$(cat ${SCPidioma})
	[[ -z $LINGUAGE ]] && LINGUAGE=en
	[[ $LINGUAGE = "en" ]] && echo "$@" && return
	[[ ! -e /usr/bin/trans ]] && wget -O /usr/bin/trans https://raw.githubusercontent.com/rudi9999/VPS-MX-8.0/master/ArchivosUtilitarios/trans &> /dev/null
	[[ ! -e ${ADM_tmp}/texto-adm ]] && touch ${ADM_tmp}/texto-adm
	source ${ADM_tmp}/texto-adm
	if [[ -z "$(echo ${texto[$@]})" ]]; then
		retorno="$(source trans -e bing -b en:${LINGUAGE} "$@"|sed -e 's/[^a-z0-9 -]//ig' 2>/dev/null)"
		echo "texto[$@]='$retorno'"  >> ${ADM_tmp}/texto-adm
		echo "$retorno"
	else
		echo "${texto[$@]}"
	fi
}

mine_port(){
	unset puertos
	declare -A port
	local portasVAR=$(lsof -V -i tcp -P -n 2>/dev/null | grep -v "ESTABLISHED" |grep -v "COMMAND" | grep "LISTEN" | grep -E 'squid|apache|dropbear|ssh|openvpn|stunnel|python|node|v2ray|badvpn-ud')
	
	if [[ -z "$portasVAR" ]]; then
		echo -e "\033[1;31m No active ports found\033[0m"
		return 1
	fi
	
	local NOREPEAT
	local reQ
	local Port
	while read port; do
		reQ=$(echo ${port}|awk '{print $1}')
		Port=$(echo ${port} | awk '{print $9}' | awk -F ":" '{print $2}')
		[[ $(echo -e $NOREPEAT|grep -w "$Port") ]] && continue
		NOREPEAT+="$Port\n"
		case ${reQ} in
			squid|squid3)
			[[ -z ${port[SQD]} ]] && local port[SQD]="\033[1;31m SQUID: \033[1;32m"
			port[SQD]+="$Port ";;
			apache|apache2)
			[[ -z ${port[APC]} ]] && local port[APC]="\033[1;31m APACHE: \033[1;32m"
			port[APC]+="$Port ";;
			ssh|sshd)
			[[ -z ${port[SSH]} ]] && local port[SSH]="\033[1;31m SSH: \033[1;32m"
			port[SSH]+="$Port ";;
			dropbear)
			[[ -z ${port[DPB]} ]] && local port[DPB]="\033[1;31m DROPBEAR: \033[1;32m"
			port[DPB]+="$Port ";;
			ssserver|ss-server)
			[[ -z ${port[SSV]} ]] && local port[SSV]="\033[1;31m SHADOWSOCKS: \033[1;32m"
			port[SSV]+="$Port ";;
			openvpn)
			[[ -z ${port[OVPN]} ]] && local port[OVPN]="\033[1;31m OPENVPN(TCP): \033[1;32m"
			port[OVPN]+="$Port ";;
			stunnel4|stunnel)
			[[ -z ${port[SSL]} ]] && local port[SSL]="\033[1;31m SSL: \033[1;32m"
			port[SSL]+="$Port ";;
			python|python3)
			[[ -z ${port[PY3]} ]] && local port[PY3]="\033[1;31m PYTHON: \033[1;32m"
			port[PY3]+="$Port ";;
			node|nodejs)
			[[ -z ${port[WS]} ]] && local port[WS]="\033[1;31m WEBSOCKET: \033[1;32m"
			port[WS]+="$Port ";;
			v2ray)
			[[ -z ${port[V2R]} ]] && local port[V2R]="\033[1;31m V2RAY: \033[1;32m"
			port[V2R]+="$Port ";;
			badvpn-ud)
			[[ -z ${port[BAD]} ]] && local port[BAD]="\033[1;31m BADVPN: \033[1;32m"
			port[BAD]+="$Port ";;
		esac
	done <<< "${portasVAR}"

	#UDP
	local portasVAR=$(lsof -V -i UDP -P -n 2>/dev/null | grep -v "ESTABLISHED" |grep -v "COMMAND"|grep -E 'openvpn|dns-serve|v2ray')
	local NOREPEAT
	local reQ
	local Port
	while read port; do
		reQ=$(echo ${port}|awk '{print $1}')
		Port=$(echo ${port} | awk '{print $9}' | awk -F ":" '{print $2}')
		[[ $(echo -e $NOREPEAT|grep -w "$Port") ]] && continue
		NOREPEAT+="$Port\n"
		case ${reQ} in
			openvpn)
			[[ -z ${port[OVPN]} ]] && local port[OVPN]="\033[1;31m OPENVPN(UDP): \033[1;32m"
			port[OVPN]+="$Port ";;
			dns-serve)
			[[ -z ${port[SLOW]} ]] && local port[SLOW]="\033[1;31m SlowDNS: \033[1;32m"
			port[SLOW]+="$Port ";;
		esac
	done <<< "${portasVAR}"

	k=1

	for line in "${port[@]}"; do
		[[ -z "$line" ]] && continue
		let RESTO=k%2

		if [[ $RESTO -eq 0 ]]; then
			puertos+="$line\n"
		else
			puertos+="$line-"
		fi
		let k++

	done

	echo -e "$puertos"|column -t -s '-'

}

ofus () {
  unset server
  server=$(echo ${txt_ofuscatw}|cut -d':' -f1)
  unset txtofus
  number=$(expr length $1)
  for((i=1; i<$number+1; i++)); do
    txt[$i]=$(echo "$1" | cut -b $i)
    case ${txt[$i]} in
      ".")txt[$i]="*";;
      "*")txt[$i]=".";;
      "_")txt[$i]="@";;
      "@")txt[$i]="_";;
      "-")txt[$i]="K";;
      "K")txt[$i]="-";;
      "1")txt[$i]="f";;
      "2")txt[$i]="e";;
      "3")txt[$i]="d";;
      "4")txt[$i]="c";;
      "5")txt[$i]="b";;
      "6")txt[$i]="a";;
      "7")txt[$i]="9";;
      "8")txt[$i]="8";;
      "9")txt[$i]="7";;
      "a")txt[$i]="6";;
      "b")txt[$i]="5";;
      "c")txt[$i]="4";;
      "d")txt[$i]="3";;
      "e")txt[$i]="2";;
      "f")txt[$i]="1";;
    esac
    txtofus+="${txt[$i]}"
  done
  echo "$txtofus" | rev
}

fun_bar(){
	comando="$1"
	txt="$2"
	_=$(
	$comando > /dev/null 2>&1
	) & > /dev/null
	pid=$!
	while [[ -d /proc/$pid ]]; do
		echo -ne " \033[1;33m$txt["
		for((i=0; i<10; i++)); do
			echo -ne "\033[1;31m##"
			sleep 0.2
		done
		echo -ne "\033[1;33m]"
		sleep 1s
		echo
		tput cuu1 && tput dl1
	done
	echo -e " \033[1;33m$txt[\033[1;31m####################\033[1;33m] - \033[1;32m100%\033[0m"
	sleep 1s
}

# FIXED fun_ip() for Ubuntu 25
fun_ip(){
  local cache_file="${ADM_tmp}/MEUIPADM"
  
  # Check if cached IP exists and is valid
  if [[ -e "$cache_file" ]]; then
    local cached_ip=$(cat "$cache_file")
    if [[ $cached_ip =~ ^[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}$ ]]; then
      echo "$cached_ip"
      return 0
    fi
  fi
  
  # Get local IP
  local local_ip=$(ip addr show 2>/dev/null | grep "inet " | grep -v "127.0.0.1" | awk '{print $2}' | cut -d'/' -f1 | head -1)
  
  # Try to get public IP with multiple methods and timeout
  local public_ip=""
  
  # Method 1: curl (preferred)
  if command -v curl &> /dev/null; then
    public_ip=$(timeout 3 curl -s -4 https://ifconfig.me 2>/dev/null || timeout 3 curl -s -4 http://icanhazip.com 2>/dev/null)
  fi
  
  # Method 2: wget (fallback)
  if [[ -z "$public_ip" ]] && command -v wget &> /dev/null; then
    public_ip=$(timeout 3 wget -qO- https://ifconfig.me 2>/dev/null || timeout 3 wget -qO- http://icanhazip.com 2>/dev/null)
  fi
  
  # Validate and use IP
  if [[ $public_ip =~ ^[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}$ ]]; then
    # Valid public IP found
    echo "$public_ip" > "$cache_file"
    echo "$public_ip"
  elif [[ $local_ip =~ ^[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}$ ]]; then
    # Fallback to local IP
    echo "$local_ip" > "$cache_file"
    echo "$local_ip"
  else
    # Last resort
    local hostname_ip=$(hostname -I 2>/dev/null | awk '{print $1}')
    if [[ $hostname_ip =~ ^[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}$ ]]; then
      echo "$hostname_ip" > "$cache_file"
      echo "$hostname_ip"
    else
      echo "127.0.0.1" > "$cache_file"
      echo "127.0.0.1"
    fi
  fi
}

fun_ip(){
  local cache_file="${ADM_tmp}/MEUIPADM"
  local cache_timeout=3600
  local current_time=$(date +%s)
  
  # Check cache
  if [[ -e "$cache_file" ]]; then
    local file_time=$(stat -c %Y "$cache_file" 2>/dev/null || stat -f %m "$cache_file" 2>/dev/null)
    local age=$((current_time - file_time))
    
    if [[ $age -lt $cache_timeout ]]; then
      local cached_ip=$(cat "$cache_file")
      if [[ $cached_ip =~ ^[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}$ ]]; then
        echo "$cached_ip"
        return 0
      fi
    fi
  fi
  
  local public_ip=""
  
  # Try multiple public IP services
  if command -v curl &> /dev/null; then
    public_ip=$(timeout 3 curl -s -4 https://ifconfig.me 2>/dev/null || timeout 3 curl -s -4 http://ifconfig.me 2>/dev/null || timeout 3 curl -s -4 http://icanhazip.com 2>/dev/null || timeout 3 curl -s -4 http://ipinfo.io/ip 2>/dev/null || timeout 3 curl -s -4 http://checkip.amazonaws.com 2>/dev/null)
  elif command -v wget &> /dev/null; then
    public_ip=$(timeout 3 wget -qO- http://icanhazip.com 2>/dev/null || timeout 3 wget -qO- http://ipinfo.io/ip 2>/dev/null)
  fi
  
  public_ip=$(echo "$public_ip" | tr -d '\n' | tr -d ' ')
  
  if [[ $public_ip =~ ^[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}$ ]]; then
    echo "$public_ip" > "$cache_file"
    echo "$public_ip"
    return 0
  fi
  
  # Fallback to local IP
  local local_ip=$(ip addr show | grep "inet " | grep -v "127.0.0.1" | awk '{print $2}' | cut -d'/' -f1 | head -1)
  
  if [[ $local_ip =~ ^[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}$ ]]; then
    echo "$local_ip" > "$cache_file"
    echo "$local_ip"
    return 0
  fi
  
  local hostname_ip=$(hostname -I 2>/dev/null | awk '{print $1}')
  
  if [[ $hostname_ip =~ ^[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}$ ]]; then
    echo "$hostname_ip" > "$cache_file"
    echo "$hostname_ip"
    return 0
  fi
  
  echo "127.0.0.1" > "$cache_file"
  echo "127.0.0.1"
}

mportas2(){
	unset portas
	portas_var=$(lsof -V -i tcp -P -n 2>/dev/null | grep -v "ESTABLISHED" |grep -v "COMMAND" | grep "LISTEN")
	while read port; do
		var1=$(echo $port | awk '{print $1}') && var2=$(echo $port | awk '{print $9}' | awk -F ":" '{print $2}')
		[[ "$(echo -e $portas|grep "$var1 $var2")" ]] || portas+="$var1 $var2\n"
	done <<< "$portas_var"
	i=1
	echo -e "$portas"
}

mportas(){
	unset portas
	portas_var=$(lsof -V -i -P -n 2>/dev/null | grep -v "ESTABLISHED" |grep -v "COMMAND")
	while read port; do
		var1=$(echo $port | awk '{print $1}') && var2=$(echo $port | awk '{print $9}' | awk -F ":" '{print $2}')
		[[ "$(echo -e $portas|grep "$var1 $var2")" ]] || portas+="$var1 $var2\n"
	done <<< "$portas_var"
	i=1
	echo -e "$portas"
}

os_system(){
  system=$(cat -n /etc/issue 2>/dev/null | grep 1 | cut -d' ' -f6,7,8 | sed 's/1//' | sed 's/      //' || echo "Unknown System")
  echo $system | awk '{print $1, $2}'
}

reiniciar_vps () {
  echo -ne " \033[1;31m[ ! ] Sudo Reboot"
  sleep 3s
  echo -e "\033[1;32m [OK]"
  (
    sudo reboot
    ) > /dev/null 2>&1
  msg -bar
  return
}

# Menu Tools
systen_info(){
  msg -ama "SYSTEM DETAILS"
  null="\033[1;31m"
  msg -bar
  
  [[ ! -f /proc/cpuinfo ]] && msg -verm "System Not Supported" && msg -bar && return 1
  [[ ! -f /proc/meminfo ]] && msg -verm "System Not Supported" && msg -bar && return 1
  
  totalram=$(free 2>/dev/null | grep Mem | awk '{print $2}')
  usedram=$(free 2>/dev/null | grep Mem | awk '{print $3}')
  freeram=$(free 2>/dev/null | grep Mem | awk '{print $4}')
  swapram=$(cat /proc/meminfo | grep SwapTotal | awk '{print $2}')
  system=$(cat /etc/issue.net 2>/dev/null || cat /etc/issue 2>/dev/null)
  clock=$(lscpu 2>/dev/null | grep "CPU max MHz" | awk '{print $4}')
  based=$(cat /etc/*release 2>/dev/null | grep ID_LIKE | awk -F "=" '{print $2}')
  processor=$(cat /proc/cpuinfo | grep "model name" | uniq | awk -F ":" '{print $2}')
  cpus=$(cat /proc/cpuinfo | grep processor | wc -l)
  
  [[ "$system" ]] && msg -ama "System: ${null}$system" || msg -ama "System: ${null}Unknown"
  [[ "$based" ]] && msg -ama "Base: ${null}$based" || msg -ama "Base: ${null}Unknown"
  [[ "$processor" ]] && msg -ama "Processor: ${null}$processor x$cpus" || msg -ama "Processor: ${null}Unknown"
  [[ "$clock" ]] && msg -ama "Operating Frequency: ${null}$clock MHz" || msg -ama "Operating Frequency: ${null}Unknown"
  msg -ama "Processor Usage: ${null}$(ps aux  | awk 'BEGIN { sum = 0 }  { sum += sprintf("%f",$3) }; END { printf " %.2f%%", sum}')"
  msg -ama "Total Virtual Memory: ${null}$(($totalram / 1024)) MB"
  msg -ama "Virtual Memory In Use: ${null}$(($usedram / 1024)) MB"
  msg -ama "Free Virtual Memory: ${null}$(($freeram / 1024)) MB"
  msg -ama "Swap Virtual Memory: ${null}$(($swapram / 1024)) MB"
  msg -ama "Time Online: ${null}$(uptime)"
  msg -ama "Machine Name: ${null}$(hostname)"
  msg -ama "Machine IP: ${null}$(ip addr show 2>/dev/null | grep "inet " | grep -v "127.0.0.1" | awk '{print $2}' | cut -d'/' -f1 | head -1)"
  msg -ama "Kernel Version: ${null}$(uname -r)"
  msg -ama "Architecture: ${null}$(uname -m)"
  msg -bar
  return 0
}

# Menu Installations
pid_inst(){
	[[ $1 = "" ]] && echo -e "\033[1;31m[OFF]" && return 0
	unset portas
	portas_var=$(lsof -V -i -P -n 2>/dev/null | grep -v "ESTABLISHED" |grep -v "COMMAND")
	i=0
	while read port; do
		var1=$(echo $port | awk '{print $1}') && var2=$(echo $port | awk '{print $9}' | awk -F ":" '{print $2}')
		[[ "$(echo -e ${portas[@]}|grep "$var1 $var2")" ]] || {
			portas[$i]="$var1 $var2\n"
			let i++
		}
	done <<< "$portas_var"
	[[ $(echo "${portas[@]}"|grep "$1") ]] && echo -e "\033[1;32m[ON]" || echo -e "\033[1;31m[OFF]"
}

info_sys(){
	info_so=$(printf '%-17s' "$(os_system)")
	info_ip=$(printf '%-18s' "$(fun_ip)")
	info_ram1=$(printf '%-7s' "${ram1}")
	info_ram2=$(printf '%-7s' "${ram2}")
	info_ram3=$(printf '%-7s' "${ram3}")
	info_fecha=$(printf '%-15s' "${_fecha}")
	info_hora=$(printf '%-15s' "${_hora}")

	systema=$(printf '%-23s' 'SYSTEM')
	systema+=$(printf '%-16s' 'MEMORY')
	systema+='PROCESSOR'

	msg -verd " $systema"

	echo -e " $(msg -teal "O.S:") $(msg -azu "$info_so") $(msg -teal "RAM:")    $(msg -verd "$info_ram1") $(msg -teal "CPU:") $(msg -verd "$_core")"
	echo -e " $(msg -teal "IP:") $(msg -azu "$info_ip") $(msg -teal "USED:")  $(msg -verd "$info_ram3") $(msg -teal "IN USE:")$(msg -verd "$_usop")"
	echo -e " $(msg -teal "DATE:") $(msg -azu "$info_fecha") $(msg -teal "FREE:")  $(msg -verd "$info_ram2")"
	echo -e " $(msg -teal "TIME:")  $(msg -azu "$info_hora") $(msg -teal "IN USE:") $(msg -verd "$_usor")"
}

cabesera(){
	msg -bar
	print_center -azu "=====>>>> ADMRufu <<<<====="|lolcat
	msg -bar
}

droppids(){
  port_dropbear=$(ps aux 2>/dev/null | grep 'dropbear' | grep -v grep | awk 'NR==1{print $17}')
  
  [[ -z "$port_dropbear" ]] && return 1

  log=/var/log/auth.log
  loginsukses='Password auth succeeded'

  [[ ! -f "$log" ]] && return 1

  pids=$(ps ax 2>/dev/null | grep 'dropbear' | grep " $port_dropbear" | awk -F " " '{print $1}')

  for pid in $pids; do
    pidlogs=$(grep $pid $log 2>/dev/null | grep "$loginsukses" | awk -F" " '{print $3}')

    i=0
    for pidend in $pidlogs; do
      let i=i+1
    done

    if [[ ! -z "$pidend" ]]; then
       login=$(grep $pid $log 2>/dev/null | grep "$pidend" | grep "$loginsukses")
       PID=$pid
       user=$(echo $login | awk -F" " '{print $10}' | sed -r "s/'/ /g")
       waktu=$(echo $login | awk -F" " '{print $2"-"$1,$3}')
       while [ ${#waktu} -lt 13 ]; do
           waktu=$waktu" "
       done
       while [ ${#user} -lt 16 ]; do
           user=$user" "
       done
       while [ ${#PID} -lt 8 ]; do
           PID=$PID" "
       done
       echo "$user $PID $waktu"
    fi
  done
}

contador(){
	users=$(cat /etc/passwd 2>/dev/null | grep 'home' | grep 'false' | grep -v 'syslog' | awk -F ':' '{print $1}')
	dpids=$(droppids)
	time=$(date +%s)
	[[ -e /etc/openvpn/openvpn-status.log ]] && ovpn_log=$(cat /etc/openvpn/openvpn-status.log)

	n='0'
	i='0'
	conect='0'
	for _user in $users; do
		[[ -z "$(ps -u $_user 2>/dev/null | grep sshd)" ]] && sqd=0 || sqd=1
		[[ -z "$(echo $ovpn_log | grep -E ,"$_user",)" ]] && ovp=0 || ovp=1
        [[ -z "$(echo $dpids | grep -w "$_user")" ]] && drop=0 || drop=1

        conex=$(($sqd + $ovp + $drop))
        [[ $conex -ne 0 ]] && let conect++

		if [[ $(chage -l $_user 2>/dev/null | grep 'Account expires' | awk -F ': ' '{print $2}') != never ]]; then
			[[ $time -gt $(date '+%s' -d "$(chage -l $_user 2>/dev/null | grep "Account expires" | awk -F ': ' '{print $2}')") ]] && let n++
		fi
		[[ $(passwd --status $_user 2>/dev/null | cut -d ' ' -f2) = "L" ]] && let i++
	done

	_onlin=$(printf '%-7s' "$conect")
	_userexp=$(printf '%-7s' "$n")
	_lok=$(printf '%-7s' "$i")
	_tuser=$(echo "$users" | sed '/^$/d' | wc -l)

	echo -e " $(msg -verd "ONLI:") $(msg -azu "$_onlin") $(msg -verm2 "EXP:") $(msg -azu "$_userexp") $(msg -teal "LOK:") $(msg -azu "$_lok") $(msg -ama "TOTAL:") $(msg -azu "$_tuser")"
}

lou(){
  source <(echo -e "$(cat /etc/bash.bashrc)\nTMOUT=1")
}

ULK_ALF(){
	title "Disable Alphanumeric Passwords"
	msg -ama " This will disable the use of Alphanumeric passwords\n in VULTR VPS, and others. Allowing to use any\n combination of characters greater than 4 digits."
	msg -bar
	msg -ne " Continue? [Y/N]: "
	read opcion
	[[ "$opcion" != @(s|S|y|Y) ]] && return
	tput cuu1 && tput dl1
	apt-get install libpam-cracklib -y > /dev/null 2>&1
	echo -e '#
password [success=1 default=ignore] pam_unix.so obscure sha512
password requisite pam_deny.so
password required pam_permit.so' > /etc/pam.d/common-password
    chmod +x /etc/pam.d/common-password
    print_center -verd "Alphanumeric Password Disabled"
    msg -bar
    print_center -ama "►► Press enter to continue ◄◄"
    read
}

backup(){

	bkusr(){
    all_user=$(cat /etc/passwd 2>/dev/null | grep 'home' | grep 'false' | grep -v 'syslog')
    all_name=('' $(echo "$all_user" | awk -F ':' '{print $1}'))
		clear
		msg -bar
		if [[ -z ${all_name[@]} ]]; then
			print_center -ama "No users found"
			msg -bar
			enter
			return
		fi
		print_center -ama "CREATING BACKUP"
		msg -bar
		sleep 2
		local userback
		for u in `echo ${all_name[@]}`; do
      dat=$(echo "$all_user" | grep -w "$u" | cut -d ':' -f5)
      Limit_mode=$(echo "$dat" | cut -d ',' -f1)
      case $Limit_mode in
        token)pass=$(cat ${ADM_user}/passwd_token 2>/dev/null);;
         hwid)pass="$u";;
            *)pass=$(echo "$dat" | cut -d ',' -f2);;
      esac
			fecha=$(chage -l "$u" 2>/dev/null | sed -n '4p' | awk -F ': ' '{print $2}')
			EXPTIME="$(($(($(date '+%s' -d "${fecha}") - $(date +%s))) / 86400))"
			stat=$(passwd --status $u 2>/dev/null | cut -d ' ' -f2)
      userback+="$u|$pass|$EXPTIME|$dat|$stat\n"
		done
		echo -e "$userback" > ${ADM_tmp}/userback.txt
    echo -e "$userback" > /root/userback.txt
		openssl enc -aes-128-cbc -salt -in ${ADM_tmp}/userback.txt -pass pass:ADMRufu -out ${ADM_tmp}/userback.enc > /dev/null 2>&1
		mv ${ADM_tmp}/userback.enc /root/user_$(printf '%(%d-%m-%y_%H:%M:%S)T').ADMRufu
		rm ${ADM_tmp}/userback.txt
		print_center -verd "Backup created."
		enter
		return
	}

  restor(){
    openssl enc -aes-128-cbc -d -in ${ADM_tmp}/userback.enc -pass pass:ADMRufu -out ${ADM_tmp}/userback.txt &>/dev/null 2>&1
    msg -nama " Delete all users? [Y/N]: " && read del_all
    [[ "$del_all" != @(S|s|Y|y) ]] && msg -nama " Overwrite existing users? [Y/N]: " && read reset_user
    all_user=$(cat /etc/passwd 2>/dev/null | grep 'home' | grep 'false' | grep -v 'syslog')
    if [[ "$del_all" = @(S|s|Y|y) ]]; then
      systemctl stop dropbear &>/dev/null
      systemctl stop sshd &>/dev/null
      systemctl stop ssh &>/dev/null
      systemctl stop stunnel4 &>/dev/null
      systemctl stop squid &>/dev/null
      title -ama "DELETING ALL USERS...."
      for user_d in `echo "$all_user" | awk -F ':' '{print $1}'`; do
        userpid=$(ps -u $user_d 2>/dev/null | awk '{print $1}')
        kill "$userpid" 2>/dev/null
        userdel --force $user_d 2>/dev/null
      done
      systemctl start sshd &>/dev/null
      systemctl start ssh &>/dev/null
      systemctl start dropbear &>/dev/null
      systemctl start stunnel4 &>/dev/null
      systemctl start squid &>/dev/null
    fi
    clear
    msg -bar
    print_center -ama "RESTORING BACKUP"
    msg -bar
    all_name=($(echo "$all_user" | awk -F ':' '{print $1}'))
    while read line; do
      user=$(echo $line | cut -d '|' -f1)
      pass=$(echo $line | cut -d '|' -f2)

      dias=$(( $(echo $line | cut -d '|' -f3) + 1 ))

      if [[ "$dias" -lt 1 ]]; then dias=0 ;fi

      dat=$(echo $line | cut -d '|' -f4)
      stat=$(echo $line | cut -d '|' -f5)

      if [[ $(echo "${all_name[@]}" | grep "$user") = "" ]]; then
        valid=$(date '+%C%y-%m-%d' -d " +$dias days")
        msg -nama " $user"
        if useradd -M -s /bin/false -e ${valid} -K PASS_MAX_DAYS=$dias -p $(openssl passwd -6 $pass) -c $dat $user 2>/dev/null ; then
          [[ "$stat" = "P" ]] && usermod -U $user 2>/dev/null || usermod -L $user 2>/dev/null
          msg -verd " Restored"
        else
          msg -verm2 " NO, User not restored"
        fi 
      else
        if [[ "$reset_user" = @(S|s|Y|y) ]]; then
          userpid=$(ps -u $user 2>/dev/null | awk '{print $1}')
          kill "$userpid" 2>/dev/null
          userdel --force $user 2>/dev/null
          if useradd -M -s /bin/false -e ${valid} -K PASS_MAX_DAYS=$dias -p $(openssl passwd -6 $pass) -c $dat $user 2>/dev/null ; then
            [[ "$stat" = "P" ]] && usermod -U $user 2>/dev/null || usermod -L $user 2>/dev/null
            msg -verd " Restored"
          else
            msg -verm2 " NO, User not restored"
          fi
        else
            echo -e " $(msg -ama "$user") $(msg -verm2 "Already Exists")"
        fi
      fi
    done <<< $(cat "${ADM_tmp}/userback.txt")

    rm ${ADM_tmp}/userback.enc
    rm ${ADM_tmp}/userback.txt
    enter

  }

	rsurs(){
		clear
		msg -bar
		print_center -ama "RESTORE BACKUP"
		msg -bar
		n=0
		for i in ${backls[@]}; do
      let n++
			echo -e " $(msg -verd "[$n]") $(msg -verm2 ">") $(msg -azu "$i")"
		done
		back
    opcion=$(selection_fun $n)
		[[ "$opcion" = "0" ]] && return
		let opcion--
		cp /root/${backls[$opcion]} ${ADM_tmp}/userback.enc
    restor
    return
	}

	clbk(){
		rm -rf /root/*.ADMRufu
		clear
		msg -bar
		print_center -ama "BACKUP RECORD DELETED"
		enter
	}

  rest_online(){
    title -ama "ONLINE BACKUP URL"
    echo -e " $(msg -verm3 "╭╼╼╼╼╼╼╼╼╼╼╼╼╼╼╼╼[")$(msg -azu "ENTER THE URL")$(msg -verm3 "]")"
    echo -ne " $(msg -verm3 "╰╼")\033[37;1m> " && read url
    [[ -z "$url" ]] && return
    wget -O ${ADM_tmp}/userback.enc "${url}" &>/dev/null; chmod +x ${ADM_tmp}/userback.enc
    restor
    return
  }

	backls=($(ls /root 2>/dev/null | grep '.ADMRufu'))
	var="${#backls[@]}"
	[[ ${var} = "0" ]] && bkusr && return
	title "USER BACKUP"
	menu_func "CREATE NEW USER BACKUP" "RESTORE USER BACKUP" "ONLINE BACKUP $(msg -verm2 "beta")" "CLEAR BACKUP RECORD"
	back
	msg -ne " option: "
	read opcion
	case $opcion in
		1)bkusr;;
		2)rsurs;;
		3)rest_online;;
		4)clbk;;
		0)return;;
	esac
}

remove_script(){
	title "REMOVE ADMRufu SCRIPT"
	in_opcion "Remove script [Y/N]"
	[[ "$opcion" != @(s|S|y|Y) ]] && return
	sed -i '/Rufu/d' /root/.bashrc
	sed -i '/Rufu/d' /etc/bash.bashrc
	rm -rf /usr/bin/menu
	rm -rf /usr/bin/adm
	rm -rf /usr/bin/ADMRufu
	rm -rf /etc/ADMRufu
	echo "SCRIPT REMOVED, REBOOTING VPS"
	sleep 5
	reboot
}

update(){
	title "YOU ARE ABOUT TO UPDATE ADMRufu"
	print_center -ama "To update ADMRufu, you need a key"
	msg -bar
	in_opcion "DO YOU WANT TO CONTINUE [Y/N]"

	if [[ "$opcion" = @(s|S|y|Y) ]]; then
		rm -rf /root/install.sh*
		wget -O /root/install.sh https://raw.githubusercontent.com/rudi9999/ADMRufu/main/install.sh &>/dev/null
		chmod +x /root/install.sh*
		/root/install.sh --update
	fi
}

acount_mode(){
	[[ ! -e ${ADM_user}/userMODE ]] && echo "userSSH" > ${ADM_user}/userMODE
	mode=$(cat ${ADM_user}/userMODE)
	case $mode in
		userSSH)${ADM_inst}/userSSH;;
		userHWID)${ADM_inst}/userHWID;;
		userTOKEN)${ADM_inst}/userTOKEN;;
	esac
}

# MENU EXECUTION
export -f fun_trans
export -f fun_ip
export -f info_sys
export -f mine_port
export -f os_system
export -f fun_bar
export -f fun_eth
export -f mportas
export -f in_opcion
export -f droppids
export -f backup
export -f ULK_ALF
clear
#########MENU VISUALIZATION
cabesera
if [[ $(cat ${ADM_tmp}/style|grep -w "infsys"|awk '{print $2}') = "1" ]] ; then
  info_sys
  msg -bar
fi

if [[ $(cat ${ADM_tmp}/style|grep -w "port"|awk '{print $2}') = "1" ]] ; then
  mine_port
  msg -bar
fi

if [[ $(cat ${ADM_tmp}/style|grep -w "resel"|awk '{print $2}') = "1" ]] ; then
  echo -e "\033[1;34m $(cat ${ADM_tmp}/message.txt)\033[0m"
  msg -bar
fi

if [[ $(cat ${ADM_tmp}/style|grep -w "contador"|awk '{print $2}') = "1" ]] ; then
  contador
  msg -bar
fi

v=$(cat $ADMRufu/vercion 2>/dev/null)
up=$v && [[ -e "$ADMRufu/new_vercion" ]] && up=$(cat $ADMRufu/new_vercion)

menu_func "MANAGE ACCOUNTS (SSH/DROPBEAR)" \
"-bar3 MANAGE ACCOUNTS (V2ray)" \
"-bar3 \033[1;100mSYSTEM PREPARATION\033[0m" \
"-vm UNINSTALL PANEL"

r='5'; u='u'
if [[ ! -z "$v" ]] && [[ ! -z "$up" ]] && [[ "$(date '+%s' -d "$up" 2>/dev/null)" -gt "$(date '+%s' -d "$v" 2>/dev/null)" ]]; then
	msg -bar3
	r='6'; u='5'
	echo -e "$(msg -verd " [$u]") $(msg -verm2 ">") $(msg -azu "UPDATE:") $(msg -ama "$v") $(msg -verm2 ">>>") $(msg -verd "$up")"
fi
msg -bar && echo -ne "$(msg -verd " [0]") $(msg -verm2 ">") $(msg -bra "\033[1;41m EXIT SCRIPT ")" && echo -e "$(msg -verd " [$r]") $(msg -verm2 ">") $(msg -bra "\033[1;44m REBOOT VPS \033[0m")"
msg -bar
selection=$(selection_fun -nama $r)

case ${selection} in
	1)acount_mode;;
	2)${ADM_inst}/userV2ray.sh;;
	3)${ADMRufu}/menu_inst.sh;;
	4)remove_script;;
 "$r")reiniciar_vps;;
 "$u")update;;
	0)clear && cd $HOME && exit 0;;
esac
${ADMRufu}/menu